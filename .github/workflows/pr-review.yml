name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get PR diff
        id: get-diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > pr.diff
          echo "Diff size: $(wc -l < pr.diff) lines"
          
      - name: Review with Claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          # Read the diff
          DIFF=$(cat pr.diff)
          
          # Exit if diff is empty
          if [ -z "$DIFF" ]; then
            echo "No changes detected in PR"
            exit 0
          fi
          
          # Create prompt for Claude with specific instructions
          PROMPT="You are an expert code reviewer. Carefully analyze this pull request and identify ALL issues, including:

          **Critical Issues to Check:**
          1. Wrong imports (importing from non-existent modules, incorrect package names, unused imports)
          2. Syntax errors (missing brackets, incorrect indentation, malformed code)
          3. Logic errors (incorrect conditions, off-by-one errors, null pointer risks)
          4. Security vulnerabilities (SQL injection, XSS, hardcoded secrets, insecure dependencies)
          5. Performance issues (inefficient loops, memory leaks, unnecessary operations)
          6. Code quality (duplicate code, poor naming, missing error handling)
          7. Best practices violations (not following language conventions, anti-patterns)
          8. Type errors (incorrect type usage, missing type annotations where needed)
          9. Potential runtime errors (division by zero, index out of bounds, undefined variables)
          10. Breaking changes (API changes that could break existing code)

          **Review Format:**
          - Start with a severity rating: üî¥ CRITICAL | üü° WARNING | üü¢ MINOR
          - List specific issues with line numbers where possible
          - Explain WHY each issue is a problem
          - Suggest concrete fixes
          - If NO issues found, explicitly state: 'No issues detected - code looks good ‚úÖ'

          **Be thorough and critical. Do not approve code with defects.**

          Here is the git diff to review:
          
          \`\`\`diff
          $DIFF
          \`\`\`"
          
          # Escape the prompt for JSON
          PROMPT_ESCAPED=$(echo "$PROMPT" | jq -Rs .)
          
          # Call Claude API
          echo "Calling Claude API for review..."
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "content-type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d '{
              "model": "claude-sonnet-4-20250514",
              "max_tokens": 8192,
              "temperature": 0.3,
              "messages": [{
                "role": "user",
                "content": '"$PROMPT_ESCAPED"'
              }]
            }')
          
          # Extract the review text
          REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text // "Error: Could not get review from Claude"')
          
          # Check if we got an error
          if echo "$RESPONSE" | jq -e '.error' > /dev/null; then
            ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error.message')
            echo "Error from Claude API: $ERROR_MSG"
            REVIEW="‚ö†Ô∏è **Error calling Claude API:** $ERROR_MSG"
          fi
          
          # Escape the review for JSON
          REVIEW_ESCAPED=$(echo "$REVIEW" | jq -Rs .)
          
          # Post review to PR
          echo "Posting review to PR..."
          curl -s -X POST \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" \
            -d '{"body":"## ü§ñ Claude AI Code Review\n\n'"$REVIEW"'"}'
          
          echo "Review posted successfully!"
