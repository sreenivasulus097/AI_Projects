name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0
      
      - name: Get changed files
        id: get-files
        run: |
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(py|js|ts|java|go|rb|php|cpp|c|h)$' || echo "")
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No code files changed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          echo "Changed Files Review" > review_content.txt
          echo "" >> review_content.txt
          
          for file in $CHANGED_FILES; do
            if [ -f "$file" ]; then
              echo "File: $file" >> review_content.txt
              cat "$file" >> review_content.txt
              echo "" >> review_content.txt
            fi
          done
          
          echo "Git Diff" >> review_content.txt
          git diff origin/${{ github.base_ref }}...HEAD >> review_content.txt
          
      - name: Review with Claude
        if: steps.get-files.outputs.has_changes == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          CONTENT=$(cat review_content.txt)
          
          PROMPT="You are an expert code reviewer. Find ALL bugs, errors, and issues.

          Check for:
          1. Syntax errors
          2. Import errors  
          3. Runtime errors
          4. Logic errors
          5. Security issues
          
          If you find issues, respond with:
          DEFECTS FOUND
          List each issue with severity and location.
          
          If no issues, respond with:
          NO ISSUES FOUND
          
          Code to review:
          $CONTENT"
          
          PROMPT_JSON=$(jq -n --arg p "$PROMPT" '$p')
          
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "content-type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d '{
              "model": "claude-sonnet-4-20250514",
              "max_tokens": 8000,
              "temperature": 0.2,
              "messages": [{
                "role": "user",
                "content": '"$PROMPT_JSON"'
              }]
            }')
          
          REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text')
          
          REVIEW_JSON=$(jq -n --arg r "$REVIEW" '$r')
          
          COMMENT_BODY=$(jq -n --arg r "$REVIEW" '{"body": ("## Claude AI Code Review\n\n" + $r)}')
          
          curl -s -X POST \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" \
            -d "$COMMENT_BODY"
          
          echo "Review posted"
